---
import { Image } from 'astro:assets';
import { getSlugById } from '../utils/slugs';

interface Props {
  item: {
    id: string;
    name: string;
    filename: string;
    width: number;
    height: number;
  };
  imageMap: Map<string, any>;
}

const { item, imageMap } = Astro.props;
const imageSource = imageMap.get(item.filename);
const itemSlug = getSlugById(item.id);
const isGif = (filename: string) => filename.toLowerCase().endsWith('.gif');
---

<div class="gallery-item" data-show="true">
  <a href={`/gallery/${itemSlug}/`} data-gallery-item>
    {imageSource ? (
      isGif(item.filename) ? (
        <img
          src={imageSource.src}
          alt={item.name}
          width={item.width}
          height={item.height}
          loading="lazy"
          style={`aspect-ratio: ${item.width}/${item.height}`}
        />
      ) : (
        <Image
          src={imageSource}
          alt={item.name}
          width={item.width}
          height={item.height}
          loading="lazy"
          sizes="(min-width: 1024px) 400px, (min-width: 768px) 32vw, 98vw"
          widths={[320, 400, 800]}
          style={`aspect-ratio: ${item.width}/${item.height}`}
        />
      )
    ) : (
      <div class="error-placeholder" style="aspect-ratio: 16/9; background: var(--gray-200); display: flex; align-items: center; justify-content: center; padding: 1rem; text-align: center;">
        Image not found: {item.filename}
      </div>
    )}
    <div class="gallery-item-info">
      {item.name}
    </div>
  </a>
</div>

<style lang="scss">
  .gallery-item {
    position: relative;
    margin-bottom: 1em;

    a {
      display: block;
      text-decoration: none;
      color: inherit;
      transition: background 0.2s ease;
      border-radius: 6px;
      padding: 3px;
      background: var(--base);
      border: 1px solid var(--gray-3);

      &:hover{
        background: var(--gray-4);
        border-color: var(--gray-4);
      }
    }

    img {
      width: 100%;
      height: auto;
      object-fit: contain;
      display: block;
      border-radius: 4px;
    }

    .gallery-item-info {
      padding: .4rem;
      position: absolute;
      top: 12px;
      left: 12px;
      background: rgba(0, 0, 0, 0.6);
      color: #fff;
      opacity: 0;
      backdrop-filter: blur(4px);
      transition: opacity 0.3s ease;
      font-size: .625rem;
      font-weight: 500;
      border-radius: 4px;
      max-width: calc(100% - 24px);
    }

    &:hover .gallery-item-info {
      opacity: 1;
    }
  }
</style>
